# CHAPTER 12. Effective Troubleshooting

<i>효과적인 장애 조치</i>

<br>

> 단순히 시스템의 동작을 이해한다고 해서 전문가가 될 수 있는 것은 아니다.  
> **전문성은 시스템이 동작하지 않는 이유에 대해 연구하는 과정에서 얻어지는 것**이다.  
> 
> — 브라이언 레드맨(Brian Redman)


장애 조치는 크게 두 가지 요소와 관련이 있음.

- **첫 번째**: 장애 조치를 범용적으로 수행
  - 범용적이란 특정 시스템에 대한 지식 없이 실행할 수 있다는 의미.
  - 이 방법은 결국 효율적이지 않으며 별 효과도 없는 것으로 드러남.
- **두 번째**: 시스템에 대한 탄탄한 이해
  - 해당 시스템에 익숙하지 않은 SRE의 효율성을 제한하는 경향이 있음.

## 이론

애플리케이션의 장애 조치 방법: **가설 연역 방법 (hypothetico-deductive method)**

시스템을 관찰한 결과와 시스템의 행동에 대한 이해를 바탕으로 한 이론적 기반을 통해 장애의 잠재적 원인에 대해 계속해서 가설을 세워 나가고, 이 가설을 시험하는 방법.

<br/><img src="./img/figure12-1.png" width="60%" /><br/>

1. 이상이 생겼을 때 문제 보고를 받는 것에서 시작.
2. 시스템의 측정 데이터와 로그를 통해 현재 상태 파악.
3. 이 정보를 시스템의 구현 방식, 동작 방식, 장애 복구 모드 등의 지식과 결합하여 가능한 원인 규명.


근본 원인(root cause)이 발견될 때까지 계속해서 테스트를 수행하고, 
원인이 발견되면 장애 재발 방지를 위해 그에 대한 조치를 수행한 후 포스트모텀 문서 작성. 

직접적인 원인은 근본 원인을 발견하거나 포스트모텀 문서를 작성할 때까지 기다릴 필요 없이 바로 수정 가능.


<pre>
<b>Common Pitfalls</b>

비효율적인 장애 조치 세션은 장애 등급 선정, 분석 및 진단 단계에 영향을 미침.

<b>쉽게 빠지기 쉬운 함정들</b>:

- 관련이 없는 증상을 들여다보거나 시스템의 지표의 의미를 잘못 이해하는 경우, 결과만 쫓는 행동일 뿐임.
- 시스템의 변경이나 입력값 혹은 환경에 대한 잘못된 이해는 안전하고 효과적인 가설의 검증을 방해함.
- 장애 원인에 대한 가능성이 희박한 가설을 세우거나 과거에 발생한 문제의 원인과 결부시키는 행위.
- 사실은 우연히 발생했거나 동일한 원인에 의해 발생한 관련 현상들을 계속해서 쫓아다니는 행위.
</pre>

<br>

## In Practice

## In Practice

<br>

### #1. Problem Report (문제 보고)

모든 문제 해결은 문제에 대한 보고에서 시작됨.

효과적인 문제 보고는 실제로 기대한 동작, 현재 동작, 문제 재현 방법을 설명해야 함.

이상적인 경우, 문제 보고는 일정한 양식으로 구성되어 버그 추적 시스템(bug tracking system) 등 검색 가능한 위치에 저장해야 함.

특정인에게 문제를 직접 보고하는 방법은 아래와 같은 이유로 많은 팀에서 지양함:

- 보고받은 내용을 버그로 옮겨 적는 불필요한 과정을 요구.
- 팀의 다른 구성원에게 도움되지 않는 낮은 품질의 보고서를 양산.
- 보고자가 특정 구성원에게 문제 해결 부담을 지우는 경향.

<br>

### #2. Triage (문제의 우선순위 판단)

문제 보고 후 대처 방법을 찾는 단계.

우선 시스템이 가능한 정상적으로 동작하게 만드는 것이 중요.  
근본 원인을 찾다가 시스템이 죽어버리면 사용자에게 도움이 되지 않기 때문.

> 숙련된 파일럿은 긴급 상황에서 최우선 과제로 비행기를 계속 비행하게 해야 한다고 가르침.  
> 두 번째로 취할 조치는 비행기와 모든 것을 안전하게 착륙시키는 것.

<br>


### #3. Examine (문제를 관찰하기)

#### 1️⃣ 모니터링 지표
모니터링 시스템이 시스템의 모든 지표를 기록하고 있어야 함.  
시계열 데이터를 그래프화하여 특정 일부분의 동작을 이해하고 문제 발생 위치를 암시하는 연관관계를 찾는 것이 효과적임.

#### 2️⃣ 로그
Dapper 같은 도구를 이용하여 전체 스택에 걸쳐 요청을 추적하는 것은 분산 시스템이 어떻게 동작하는지를 이해할 수 있는 강력한 방법임.

#### 3️⃣ 상태 외부 노출
구글 서버들은 발신 및 수신한 RPC의 예시를 보여주는 종단점을 가지고 있어 아키텍처 다이어그램 없이도 서버 간 통신을 쉽게 이해할 수 있음. RPC 종류별로 에러율과 지연 응답 기록을 통해 문제가 있는 서버를 빠르게 확인 가능.

#### 4️⃣ 요청/응답 확인

클라이언트가 컴포넌트가 수신할 수 있는 요청과 그에 대한 응답을 미리 확인할 수 있도록 도구 제공 필요.

> **셰익스피어 서버의 디버깅**  
> 
> `curl`을 이용해 `/search` 종단점에 요청을 보낸 결과, 데이터 없이 HTTP 응답 코드 `502 (Bad Gateway)` 를 수신.  
> 
> `X-Request-Trace` HTTP 헤더를 통해 모든 백엔드 서버의 주소 목록을 확인하고 각 서버의 응답 여부를 점검함.

<br>


### #4. Diagnose (진단)

#### 1️⃣ Simplify and reduce

_단순화와 범위 좁히기._ 

시스템을 각 계층별로 분할하여 각 컴포넌트의 올바른 동작을 확인하며 문제를 해결.

거대한 시스템의 경우, 순차적으로 진행하기에는 시간이 오래 걸릴 수 있어 시스템을 반으로 나누어 각 컴포넌트 사이의 통신 경로를 확인하는 것이 바람직함.

#### 2️⃣ Ask "what," "where," and "why"

시스템이 어떤 동작을 수행하고 있는지, 왜 이러한 동작을 하는지, 자원 이용 위치와 결과 전달 위치를 확인함으로써 문제 파악에 도움을 줌.

#### 3️⃣ What touched it last

문제 발생 시 가장 최근에 변경된 부분이 문제 원인일 가능성이 높음.

<br/><img src="./img/figure12-2.png" width="80%" /><br/>

#### 4️⃣ Specific diagnoses
광범위한 문제들을 인지하는 것보다는 특정 서비스 분석에 도움이 되는 도구와 시스템을 개발하는 것이 나음.

<br>

### Test and Treat



