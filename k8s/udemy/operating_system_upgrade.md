# Operating System Upgrade

목표: 쿠버네티스 운영 상, 소프트웨어 기반 업그레이드나 패치 적용, 보안 패치 등을 위해 
어떻게 노드를 내릴 수 있을지

몇몇의 노드를 가진 클러스터를 가정해보자.

```
Master    🟠🔴     🟠🟡     🟡🟢
 Node    Node 1   Node 2   Node 3
```

만약, 노드 하나가 다운되면 어떻게 될까?


```
Master    ⚪️⚪️     🟠🟡     🟡🟢
 Node    Node 1   Node 2   Node 3
```

물론 해당 노드의 Pod는 접근 불가능하지만, Pod를 어떻게 배치하느냐에 따라 사용자가 영향을 받을 수 있음

가령, 🟠 Pod의 복제본이 있으니 🟠 Pod에 액세스하는 사용자는 영향을 받지 않음

해당 트래픽을 🟠을 통해 처리할 수 있음

하지만 Node 1이 🔴을 실행하는 유일한 Pod이기 때문에 🔴에 접속하는 사용자는 영향을 받음

쿠버네티스는 이 사건에서 뭘 했을까요?

만약, 노드가 바로 살아나면, kubelet 프로세스가 시작되고 포드가 온라인으로 돌아옴 

하지만 노드가 5분 이상 다운되면 해당 노드에서 Pod가 종료됨

쿠베르네테스 족은 죽은 거로 여기죠

포드가 복제품 세트의 일부라면 다른 노드에 재현될 거예요

포드가 복구되길 기다리는 시간은 포드 퇴거 타임아웃으로 컨트롤러 관리자에게 5분이라는 기본 값을 설정해요

노드가 오프라인이 될 때마다 마스터 노드는 최대 5분까지 기다립니다 

노드가 죽었다는 걸 알기 전에요

캡슐 퇴거 명령이 내려진 후 노드가 다시 활성화되면

캡슐이 예정돼 있지 않아도 노드가 공백이 돼요

파란 포드는 복제품 세트의 일부였기 때문에 다른 노드에 새 포드를 만들었어요

하지만 녹색 포드는 복제품이 아니기 때문에 그냥 사라졌죠

따라서 노드에서 실행할 유지 관리 작업이 있다면 노드에서

실행되는 작업이 다른 복제본을 갖고 있다는 걸 안다면

그리고 그게 단기간 중단돼도 괜찮다면 그리고 노드가

5분 내로 다시 온라인으로 돌아올 걸 확신한다면 빠른 업그레이드 재부팅이 가능하죠

하지만 그 노드가 5분 후에 다시 온라인 상태가 될지는 확신할 수 없어요

돌아올 거라고 장담할 수 없으니 더 안전한 방법이 있어요

모든 작업의 노드를 의도적으로 드레인할 수 있죠

작업이 클러스터 내 다른 노드로 이동하도록요

엄밀히 말하면 옮긴 게 아니죠

한 노드를 배수하면 해당 노드에서 포드가 정상적으로 종료되고 다른 노드에 재현돼요

노드는 통제되거나 예정에 없던 것으로 표시되어 있습니다

특정 제한을 제거하지 않으면 이 노드에서 포드 일정을 잡을 수 없다는 뜻이죠

이제 다른 노드의 포드는 안전하니 첫 번째 노드를 재부팅하세요

다시 온라인에 접속해도 여전히 계획할 수 없죠

그런 다음 코딩을 취소해야 해요 그래야 다시

포드 일정을 잡을 수 있죠

다른 노드로 옮겨진 포드가

자동으로 돌아가진 않아요

해당 포드가 삭제되거나

클러스터에 새 포드가 생성되면 이

노드에서 생성되겠죠

배수관과 코든 이외에도

코르동이라는 명령어가 있죠

경계선은 예정에 없던 종양을 표시한 것뿐이죠

배수관과 달리 기존 노드에서 포드를

종료하거나 이동시키지 않아요

단순히 해당 노드에 새 포드가 스케쥴링되지

않도록 하는 거죠

오늘 강의는 여기까지예요

모의시험 보러 가세요 모의시험 보고 배액하고

노드 차단하는 거 연습하세요

