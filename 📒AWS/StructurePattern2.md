# Structure Pattern

<br/><br/>

## Web System

기업에서 자주 이용하는 시스템을 예로들어 AWS 서비스를 어떻게 조합하여 사용하여 설계하면 좋을지 시나리오를 통해 알아보자

<br/>

### Pattern 2. Enterprise WebSite

*목표: 조금은 더 복잡한 웹사이트의 예: 웹 서버와 DB 서버의 이중화 방법, 저비용으로 정적 콘텐츠를 배포하는 방법*

<br/>

> #### Enterprise WebSite Condition
>
>
> - 공개 사이트
> - 사용자: 거래처, 잠재적 고객, 입사지원자 등
> - 서버 다중화로 장애 대비
> - 부하가 높아지면 서버 추가 구성
> - 장애 서버의 교체, 추가는 수동으로 조작
> - 응답시간과 비용 고려

<br/>

```
#### 핵심 설계 사항

1. 웹 서버 다중화
로드밸러서로 장애에 대비, 부하가 높아진 경우에 대비해 웹 서버 추가 가능

2. DB 서버 다중화
서비스 기능을 사용해 DB 서버 복제

3. CDN과 객체 저장소를 사용한 정적 콘텐츠 전송
웹 서버로부터의 접속을 줄여 운영 비용 절감
```

<br/><br/>

기업 웹사이트의 특징: 마케팅과 커뮤니케이션 도구로 중요하게 쓰이기 때문에 (기반 업무 시스템 정도는 아니지만)안정적으로 가동되어야 한다.

<br/><img src="./img/archi2-enterprise.jpg" width="40%" /><br/>

<br/>


*구성 설명*

#### 웹 서버

가상 서버인 EC2와 가상 저장소인 EBS를 사용하여 구축, 로드밸런서를 사용하여 다중으로 구성

로드밸런서 기능을 제공하는 서비스는 ELB(Elastic Load Balancing)이다.

<br/>

#### DB 서버

RDB 관리형 서비스인 RDS(AWS Relational Database Service)로 구성. 

RDS는 셋업이 완료된 RDBMS 환경을 제공하는 서비스로 간단한 설정만으로도 다중화가 가능

이렇게 관리형 서비스들을 이용해 적은 노력으로 시스템의 구성이 가능한 것이 AWS 장점

<br/>

#### 정적 콘텐츠 전송

정적 콘텐츠 전송에 이용하는 CDN 서비스가 아마존 클라우드프론트(Amazon CloudFront)이다.

CDN은 전세계에 배치된 서버를 통해 웹 접속을 캐시하거나 분배하는 서비스로, CDN을 사용하면 응답 속도를 높이거나 웹 서버로의 접속을 줄일 수 있다.

<br/>

#### 객체 저장소 서비스 

객체 저장소 서비스는 S3(Amazon Simple Storage Service, 아마존 심플 스토리지 서비스)가 있다.

객체 저장소는 객체 단위로 데이터를 다루는 스토리지로서 REST API를 이용해 데이터의 입출력을 수행한다.

<br/><br/>

### ✔️ ELB로 웹 서버 다중화

먼저, 기본적인 세팅으로 EC2에 OS와 DML(Content Management System)를 설치한다.

웹 서버 여러 대를 구축하는데, 하나씩 설정하면 번거롭기도 하고 안정적이지 못하다.

-> 가상 서버 템플릿인 AMI를 아용해 가상 서버 여러 대를 한꺼번에 셋업하고, 동일한 구성의 EC2 인스턴스로 복제하자.


<br/><img src="./img/archi2-duplication-from-AMI.jpg" width="40%" /><br/>

<br/><br/>

필요한 수의 웹 서버를 만든 후, ELB와 연계한 다중화 구성을 설정한다. 

ELB를 웹 트래픽의 입구로 사용하여 트래픽이 복수의 웹 서버에 분산되도록 한다.

1. 인터넷 접속 엔드포인트(End Point)를 ELB로 지정한다. ELB는 IP 주소가 아닌 CNAME(대체 도메인 이름)을 지정하여 접속한다. (ELB의 IP 주소는 고정이 아니라 계속 변하기 때문) DNS 서버인 아마존 Route53을 이용해 ELB의 CNAME과 사용할 도메인 이름을 연결하면 최종적으로 도메인 이름을 통해 ELB에 접근할 수 있게 된다.
2. ELB와 웹 서버의 EC2 인스턴스를 연결시킨다. ELB 작성 페이지에 웹 서버를 선택하는 항목이 있으니까 이미 만들어진 웹 서버를 선택한다.

위의 두 과정으로 ELB에 의한 부하 분산 설정이 완료된다. ELB는 웹 서버의 부하를 감시하여 부하가 낮은 웹 서버로 요청을 분산시킨다.

<br/><br/>

### ✔️ ELB 설정 시 유의사항

ELB를 설정할 때 특히 조심할 5가지

<br/>

**첫 번째. ELB와 웹 서버 보안그룹은 따로 설정**

ELB는 어디에서 어떻게 접근해도 (HTTP, HTTPS) 접속을 허용하게 되어있다.
반면, 웹 서버는 ELB로부터의 HTTP 요청만을 받아들이도록 트래픽 소스를 ELB가 속한 보안 그룹으로 한다.

이렇게 서브넷으로 설정하는 것은 ELB의 IP 주소가 바뀔 가능성이 있기 때문이다.
인터넷에서 직접적으로 웹 서버에 접속하는 것을 허용하지 말아야하는데, 개별 웹 서버에 직접 접속하면 ELB의 제어가 제대로 작동되지 않기 때문이다.

<br/>

**두 번째. 세션 유지 기능**

최근 웹 사이트는 세션 유지 기능을 이용해 복잡한 기능을 지닌 애플리케이션을 제공하는 경우가 있다.

그 때 세션 간의 공유하는 구조를 마련하지 않으면 동일한 클라이언트 접속을 항상 같은 웹 서버에 유지ㅣ시켜야만 한다. 

ELB는 ELB 자신이 작성하는 쿠키 정보를 바탕으로 동일한 서버로 접속을 유지시키는 세션 유지 기능을 제공한다.

<br/>

**세 번째, HTTPS 처리**

HTTPS 통신은 클라이언트와 서버 간의 통신을 암호화한다. ELB는 SSL 터미네이션(SSL Termination)이라고 하는 SSL 인증서 확인 및 암호화/복호화 처리 기능을 제공한다.

ELB 리스너 설정에서 로드밸러서 프로토콜을 HTTPS로, 인스턴스의 프로토콜을 HTTP로 하면 자동적으로 적용된다. 

웹 서버별로 SSL 증명서를 관리할 필요가 없어질 뿐만 아니라, SSL 복호화 처리에 걸리는 부하가 줄어들어 EC2 인스턴스의 비용을 줄일 수 있다.

<br/>

**네 번째. 헬스 체크**

웹 서버가 정상적으로 동작하는지를 감시하는 헬스 체크 설정을 지원한다.

기본 설정에서는 간격(Interval)이 30초, 타임아웃(Time out)이 5초, 비정상 상한치(Unhealthy threshold)가 2회이다. 

웹 서버에 장애가 발생하면 40초에서 70초 만애 감지하여 해당 서버를 분리하고 만다.

반대로 너무 길면 오류가 발생하는 웹 서버에 요청 배분을 계속 한다.

일반적으로 기본 설정값으로 충분하지만, 성능 시험이나 운영 시에 검출 오작동이 발생한다면 수치를 조정할 수 있다.

<br/>

**다섯 번째. 타임 아웃**

웹 서버에 분산시킨 후 일정시간 응답이 없으면, ELB는 웹 서버와의 접속을 절단하고, 클라이언트에 HTTP 504를 반환한다.
타임아웃 시간은 접속 설정의 타임 아웃으로 설정하며, 초기 설정값은 60초이다.

DB 처리 등으로 시간이 오래 걸리더라도 결과를 반환하고 싶은 경우는 시간을 길게 설정한다.

<br/><br/>

### RDS를 이요하여 DB 서버 다중화하기

AWS에서 RDB를 구성하는 방법은 크게 두 가지이다.
- EC2 인스턴스에 RBDMS를 설치하는 방법
  - OS와 RDBMS를 자유롭게 선택하고 설정할 수 있음
  - OS와 DB 환경을 사용자가 직접 관리하지 않으면 안됨
- 관리형 서비스인 RDS 이용하는 방법
  - 패치 적용과 백업이 자동화되어 있기 때문에 운영의 번거로움이 줄어듦
  - 운영과 설정의 수고를 줄일 수 있지만, DB 운영에 제약이 있음







<br/><br/><br/>
