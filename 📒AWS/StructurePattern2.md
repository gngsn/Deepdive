# Structure Pattern

<br/><br/>

## Web System

기업에서 자주 이용하는 시스템을 예로들어 AWS 서비스를 어떻게 조합하여 사용하여 설계하면 좋을지 시나리오를 통해 알아보자

<br/>

### Pattern 2. Enterprise WebSite

*목표: 조금은 더 복잡한 웹사이트의 예: 웹 서버와 DB 서버의 이중화 방법, 저비용으로 정적 콘텐츠를 배포하는 방법*

<br/>

> #### Enterprise WebSite Condition
>
>
> - 공개 사이트
> - 사용자: 거래처, 잠재적 고객, 입사지원자 등
> - 서버 다중화로 장애 대비
> - 부하가 높아지면 서버 추가 구성
> - 장애 서버의 교체, 추가는 수동으로 조작
> - 응답시간과 비용 고려

<br/>

```
#### 핵심 설계 사항

1. 웹 서버 다중화
로드밸러서로 장애에 대비, 부하가 높아진 경우에 대비해 웹 서버 추가 가능

2. DB 서버 다중화
서비스 기능을 사용해 DB 서버 복제

3. CDN과 객체 저장소를 사용한 정적 콘텐츠 전송
웹 서버로부터의 접속을 줄여 운영 비용 절감
```

<br/><br/>

기업 웹사이트의 특징: 마케팅과 커뮤니케이션 도구로 중요하게 쓰이기 때문에 (기반 업무 시스템 정도는 아니지만)안정적으로 가동되어야 한다.

<br/><img src="./img/archi2-enterprise.jpg" width="40%" /><br/>

<br/>


*구성 설명*

#### 웹 서버

가상 서버인 EC2와 가상 저장소인 EBS를 사용하여 구축, 로드밸런서를 사용하여 다중으로 구성

로드밸런서 기능을 제공하는 서비스는 ELB(Elastic Load Balancing)이다.

<br/>

#### DB 서버

RDB 관리형 서비스인 RDS(AWS Relational Database Service)로 구성. 

RDS는 셋업이 완료된 RDBMS 환경을 제공하는 서비스로 간단한 설정만으로도 다중화가 가능

이렇게 관리형 서비스들을 이용해 적은 노력으로 시스템의 구성이 가능한 것이 AWS 장점

<br/>

#### 정적 콘텐츠 전송

정적 콘텐츠 전송에 이용하는 CDN 서비스가 아마존 클라우드프론트(Amazon CloudFront)이다.

CDN은 전세계에 배치된 서버를 통해 웹 접속을 캐시하거나 분배하는 서비스로, CDN을 사용하면 응답 속도를 높이거나 웹 서버로의 접속을 줄일 수 있다.

<br/>

#### 객체 저장소 서비스 

객체 저장소 서비스는 S3(Amazon Simple Storage Service, 아마존 심플 스토리지 서비스)가 있다.

객체 저장소는 객체 단위로 데이터를 다루는 스토리지로서 REST API를 이용해 데이터의 입출력을 수행한다.

<br/><br/>

### ✔️ ELB로 웹 서버 다중화

먼저, 기본적인 세팅으로 EC2에 OS와 DML(Content Management System)를 설치한다.

웹 서버 여러 대를 구축하는데, 하나씩 설정하면 번거롭기도 하고 안정적이지 못하다.

-> 가상 서버 템플릿인 AMI를 아용해 가상 서버 여러 대를 한꺼번에 셋업하고, 동일한 구성의 EC2 인스턴스로 복제하자.


<br/><img src="./img/archi2-duplication-from-AMI.jpg" width="40%" /><br/>

<br/><br/>

필요한 수의 웹 서버를 만든 후, ELB와 연계한 다중화 구성을 설정한다. 

ELB를 웹 트래픽의 입구로 사용하여 트래픽이 복수의 웹 서버에 분산되도록 한다.

1. 인터넷 접속 엔드포인트(End Point)를 ELB로 지정한다. ELB는 IP 주소가 아닌 CNAME(대체 도메인 이름)을 지정하여 접속한다. (ELB의 IP 주소는 고정이 아니라 계속 변하기 때문) DNS 서버인 아마존 Route53을 이용해 ELB의 CNAME과 사용할 도메인 이름을 연결하면 최종적으로 도메인 이름을 통해 ELB에 접근할 수 있게 된다.
2. ELB와 웹 서버의 EC2 인스턴스를 연결시킨다. ELB 작성 페이지에 웹 서버를 선택하는 항목이 있으니까 이미 만들어진 웹 서버를 선택한다.

위의 두 과정으로 ELB에 의한 부하 분산 설정이 완료된다. ELB는 웹 서버의 부하를 감시하여 부하가 낮은 웹 서버로 요청을 분산시킨다.

<br/><br/>

### ✔️ ELB 설정 시 유의사항

ELB를 설정할 때 특히 조심할 5가지

<br/>

**첫 번째. ELB와 웹 서버 보안그룹은 따로 설정**

ELB는 어디에서 어떻게 접근해도 (HTTP, HTTPS) 접속을 허용하게 되어있다.
반면, 웹 서버는 ELB로부터의 HTTP 요청만을 받아들이도록 트래픽 소스를 ELB가 속한 보안 그룹으로 한다.

이렇게 서브넷으로 설정하는 것은 ELB의 IP 주소가 바뀔 가능성이 있기 때문이다.
인터넷에서 직접적으로 웹 서버에 접속하는 것을 허용하지 말아야하는데, 개별 웹 서버에 직접 접속하면 ELB의 제어가 제대로 작동되지 않기 때문이다.

<br/>

**두 번째. 세션 유지 기능**

최근 웹 사이트는 세션 유지 기능을 이용해 복잡한 기능을 지닌 애플리케이션을 제공하는 경우가 있다.

그 때 세션 간의 공유하는 구조를 마련하지 않으면 동일한 클라이언트 접속을 항상 같은 웹 서버에 유지ㅣ시켜야만 한다. 

ELB는 ELB 자신이 작성하는 쿠키 정보를 바탕으로 동일한 서버로 접속을 유지시키는 세션 유지 기능을 제공한다.

<br/>

**세 번째, HTTPS 처리**

HTTPS 통신은 클라이언트와 서버 간의 통신을 암호화한다. ELB는 SSL 터미네이션(SSL Termination)이라고 하는 SSL 인증서 확인 및 암호화/복호화 처리 기능을 제공한다.

ELB 리스너 설정에서 로드밸러서 프로토콜을 HTTPS로, 인스턴스의 프로토콜을 HTTP로 하면 자동적으로 적용된다. 

웹 서버별로 SSL 증명서를 관리할 필요가 없어질 뿐만 아니라, SSL 복호화 처리에 걸리는 부하가 줄어들어 EC2 인스턴스의 비용을 줄일 수 있다.

<br/>

**네 번째. 헬스 체크**

웹 서버가 정상적으로 동작하는지를 감시하는 헬스 체크 설정을 지원한다.

기본 설정에서는 간격(Interval)이 30초, 타임아웃(Time out)이 5초, 비정상 상한치(Unhealthy threshold)가 2회이다. 

웹 서버에 장애가 발생하면 40초에서 70초 만애 감지하여 해당 서버를 분리하고 만다.

반대로 너무 길면 오류가 발생하는 웹 서버에 요청 배분을 계속 한다.

일반적으로 기본 설정값으로 충분하지만, 성능 시험이나 운영 시에 검출 오작동이 발생한다면 수치를 조정할 수 있다.

<br/>

**다섯 번째. 타임 아웃**

웹 서버에 분산시킨 후 일정시간 응답이 없으면, ELB는 웹 서버와의 접속을 절단하고, 클라이언트에 HTTP 504를 반환한다.
타임아웃 시간은 접속 설정의 타임 아웃으로 설정하며, 초기 설정값은 60초이다.

DB 처리 등으로 시간이 오래 걸리더라도 결과를 반환하고 싶은 경우는 시간을 길게 설정한다.

<br/><br/>

### RDS를 이용하여 DB 서버 다중화하기

AWS에서 RDB를 구성하는 방법은 크게 두 가지이다.

- EC2 인스턴스에 RBDMS를 설치하는 방법
  - OS와 RDBMS를 자유롭게 선택하고 설정할 수 있음
  - OS와 DB 환경을 사용자가 직접 관리하지 않으면 안됨
- 관리형 서비스인 RDS 이용하는 방법
  - 패치 적용과 백업이 자동화되어 있기 때문에 운영의 번거로움이 줄어듦
  - 운영과 설정의 수고를 줄일 수 있지만, DB 운영에 제약이 있음

<br/>

**RDS의 주요 자동 메인터넌스 기능 및 제한**

<table>
<tr>
    <td rowspan="2"> 자동 유지보수 </td>
    <td> 백업 </td>
    <td> 자동적으로 백업 작성. 장애 발생 시 보통 5분 내에 복구 가능 </td>
</tr>
<tr>
    <td> 패치 </td>
    <td> 마이너 버전업이 자동적으로 적용 </td>
</tr>
<tr>
    <td rowspan="4"> 제한 </td>
    <td> OS 접속 </td>
    <td> OS 사용자로 로그인할 수 없기 때문에 프로그램이나 도구를 설치할 수 없다. 로그, 성능 관리 인터페이스는 제공됨 </td>
</tr>
<tr>
    <td> DB 관리자 사용자 이용 </td>
    <td> 관리자 권한을 지닌 사용자로 로그인할 수 없음. 파라미터 변경과 일부 관리 기능을 위한 인터페이스는 제공 </td>
</tr>
<tr>
    <td> 멀티-AZ 이외의 다중화 기능 </td>
    <td> RDBMS나 서드 파티 복제 소프트웨어를 이용한 고가용성 구성이나 오라크 RAC 등의 다중화 기능을 이용할 수 없음 </td>
</tr>
<tr>
    <td> 메인터넌스 </td>
    <td> 주 1회, 메인터넌스를 위해 중지됨 </td>
</tr>
</table>

<br/><br/>

 RDS 엔진으로는 Oracle, SQL Server, MySQL, PostgreSQL, MariaDB, Aurora
 <small>AWS에서 만든 MySQL, PostgreSQL 호환 RDS 엔진, 오로라라고 읽음</small>

<br/>

**1. 멀티-AZ 기능을 사용한 RDS 설정**

RDS 설정 화면에서 DB 서브넷 그룹을 작성
DB 서브넷은 두 가용 영역(AZ)에 각각 서브넷을 만들고 이것을 그룹화해서 만든다.
두 AZ를 사용해 서브넷을 만드는 이유는 하나의 AZ가 예상치 못한 재해로 멈추더라도 또 다른 AZ에 설치된 서브넷에서 서버가 계속 동작하도록 하기 위함

<img src="./img/archi2-rds-subnet-group.jpg" width="50%" />

<br/>

**2. RDS for MySQL(MySQL용 RDS) 인스턴스 작성**

멀티-AZ를 이용하는 옵션을 선택하고 방금 만든 DB 서브넷 그룹을 지정한다.

<br/>

이렇게 마스터와 스탠바이 2대 구성의 DB 서버(RDS 인스턴스)가 만들어졌다. 
masteruser가 자동으로 생성되므로 이를 통해 애플리케이션 사용자를 만들거나 객체, 그리고 데이터를 관리할 수 있다.
마스터와 스탠바이가 동기 복제되어 있기 때문에 마스터에 장애가 발생해도 데이터가 손실되지 않는다.
또한, 마스터와 스탠바이 2대가 동시에 작동하기 때문에 이중화 구성을 하지 않는 경우 약 2배 비용이 발생.



마스터 DB 서버에 장애가 발생하면 스탠바이가 마스터로 승격되고 기존 마스터 서버가 사용하던 서브넷에 스탠바이 서버가 새롭게 만들어진다. 이러한 일련의 작업은 자동으로 이루어지기 때문에 DB 서버에 대한 별도의 작업은 필요없다. 

엔드포인트는 DNS가 새로 만들어진 마스터 서버로 자동으로 연결되기 때문에 변경은 필요 없지만 DB 접속은 장애 복구 이후에 자동으로 연결되도록 사전에 설정해주어야 한다.

<br/><br/>

### RDS 사용 시 주의사항

<br/>

**첫 번째. 적절한 스냅샷 사용**

예를 들어, 초기 설정이 완료된 시점에서 스냅샷을 작성
RDS는 자동 백업과 수동 스냅샷 백업 방법을 지원

하지만 자동 백업은 데이터 보존 기간에 제한이 있음

*자동 백업의 데이터 보존 기간 - 기본 설정값은 1일, 최대 35일*

이기 때문에 시스템에 대한 백업을 영구적으로 저장하려면 스내ㅂ샷이 더 적합하다. 대규모 시스템의 유지보수 작업을 수행하는 경우에도 복구용 스냅샷을 만들어두는 것이 좋다.

<br/>

**두 번째. AWS에 의한 메인터넌스**

RDS는 몇 달에 한 번 꼴로 마이너 버전업이 자동 실행되어 약 30분간 정지됨

옵션인 마이너 버전 자동 업그레이드를 NO으로 설정하면 마이너 버전업이 수행되지 않음
(하지만 취약점 대응 등 강제 업드레이드가 이루어지는 경우가 있음)

Multi-AZ를 이용하는 경우, 스탠바이가 먼저 메인터넌스된 후, 장애 복구(Failover) 기능에 의해 새로운 마스터가 되고, 원래 마스터는 메인터넌스된 후에 새로운 스탠바이가 된다.

RDS의 인스턴스의 메인터넌스 윈도우로 메인터넌스를 실시하는 시간대를 제한할 수 있다.

<br/>

**세 번째. Multi-AZ 사용 시 데이터 갱신의 처리 시간 증가**

Multi-AZ 사용 시 데이터 갱신 처리에 드는 시간이 길어진다.
마스터에 업데이터한 데이터를 스탠바이에 동기화시키는 처리가 끝날 때까지 마스터는 다음의 처리를 실시할 수 없다. (필자의 경험 상 20~50% 정도 업데이트 처리 시간이 길어진다고 한다. 물론, 이용 환경이나 처리 내용에 따라 상이함)
하지만 영향을 주는 건 업데이트 처리뿐이기 때문에 기업 웹사이트처럼 참조 비율이 많은 경우는 그렇게 문제되지 않음

<small>AWS Systems Manager의 기능인 [Maintenance Windows](https://docs.aws.amazon.com/ko_kr/systems-manager/latest/userguide/systems-manager-maintenance.html)를 사용하면 운영 체제 패치, 드라이버 업데이트, 소프트웨어 또는 패치 설치와 같이 노드에서 중단 가능성이 있는 작업 수행 시기에 대한 일정을 정의할 수 있다.</small>

<br/><br/>

## 정적 콘텐츠를 낮은 비용으로 배포하기

이미지, 동영상, 자바스크립트, HTML, CSS 등의 정적 콘텐츠 제공에 많은 비용이 들기 때문에 이러한 정적 콘텐츠 전달 비용을 줄이려면 CloudFront와 S3를 사용하면 된다.

**CloudFront**

클라우드 프론트는 CDN의 일종으로 세계 각지에 배치된 서버에서 콘텐츠를 캐시하고 전달한다.
캐시에 히트한 경우에는 웹 서버와 DB 서버에 접속하지 않으므로 서버의 부하를 낮춰 운영 비용을 줄일 수 있다. 


1. 사용자가 도메인 URL로 요청, 이 때 서버의 index.html가 참조된다고 가정

개발자는 CloudFron에서 배포할 콘텐츠에 대해서는 index.html의 URL 설정에서 클라우드프론트 도메인(e.g. http://cdn.corporatesite.co.kr/)을 지정

브라우저가 클라우드 프론트에서 콘텐츠를 가져옴 

클라우드프론트에 캐시되지 않은 내용에 접속하면, ELB를 통해 origin 콘텐츠에 직접 접근한다.

일단 사용자가 액세스한 콘튼츠는 클라우드프론트에 캐시된다. 이후 같은 콘텐츠에 대한 액세스는 클라우드프론트가 캐시된 콘텐츠를 그대로 배포한다.

클라우드프론트+S3 방법은 웹 서버의 부하를 크게 줄여, 낮은 비용으로 배포할 수 있다.

**S3**
S3에 파일을 저장하면 파일 단위로 접속용 URL이 생성되며, 정적 콘텐츠 저장소로 사용된다.
S3가 EC2보다 저렴하기 때문에 비용상 유리하다.

클라우드프론트는 동적 콘텐츠를 배포할 수도 있지만, URL 와일드카드를 지정하여 정적 및 동적 콘텐츠를 구별할 수 있다는 전제이기 때문에 디렉터리 구성과 파일 네이밍 규칙도 함께 고려해야한다. (/public/, /static/ ...)

<br/><br/>

## 기업 웹사이트에 적합한 인스턴스

기업 웹사이트는 요구 사항

**요구 사항1. 안정적인 응답**

*성능이 안정된 EC2 인스턴스와 EBS 볼륨*


**요구 사항2. 장기 이용**
*장기 이용을 약정하여 할인받을 수 있는 EC2 인스턴스가 적합*

<br/>

### 안정적인 응답

스토리지 I/O 대역폭에 주의: EC2 인스턴스와 EBS 볼륨 사이는 다른 사용자와 공유하는 네트워크로 연결되어 있다. 트래픽이 대역폭의 한계치에 이르게 되면 스토리지에서 데이터를 읽는 데 시간이 걸리고 응답도 불안정하다.

EC2 인스턴스의 네트워크 대역폭: ‘낮음’, ‘중간’, ‘높음’, ‘10기가비트’
운용 초기에는 성능이 낮은 인스턴스를 설정하고, 부족하면 성능이 높은 인스턴스 타입으로 변경해도 좋다. 

<br/>

#### 안정성을 고려한 두 가지 옵션

**첫 번째, EC2 인스턴스의 옵션 - EBS 최적화 인스턴스**
: 이 옵션을 사용하면 EC2 인스턴스에서 EBS 볼륨까지 네트워크 대역폭을 보장받을 수 있다. 
인스턴스 타입에 따라 이 옵션의 지원 여부가 달라진다.

**두 번째,프로비저닝된 IOPS**
: 프로비저닝된 IOPS를 사용 하는 경우, 안정적으로 1만 IOPS 1 이상의 I/O 대역폭을 보장받을 수 있다.
<small>IOPS: 초당 디스크 I/O 횟수, 숫자가 클수록 I/O 성능이 높다</small>

<br/>

#### 성능을 고려한 두 가지 옵션

**첫 번째, EBS 최적화**
성능을 안정시키려면 EBS 최적화를 이용하자. 
피크 시의 성능을 높이려면 EBS 최적화와 프로비저닝된 IOPS를 모두 사용한다. 프로비저닝된 IOPS의 사용만으로는 대역폭이 보장되지 않기 때문에 옵션 사용의 혜택을 온전히 누릴 수 없게 되니 주의하자. 

**두 번째, 예약 인스턴스(RI) 사용**
EC2 인스턴스 과금 체계 중에서 사용한 만큼 비용을 지불하는 **온디맨드 인스턴스**가 기본적 으로 선택된다. 예약 인스턴스는 1년 또는 3년의 기간을 정하여 사용을 예약할 수 있는데 할인된 금액으로 이용할 수 있다.

<br/>

<table>
<tr>
    <td rowspan="2" colspan="2"> </td>
    <td colspan="2"> EBS 최적화 이용  </td>
</tr>
<tr>
    <td> 있음 </td>
    <td> 없음 </td>
</tr>
<tr>
    <td rowspan="2"> 프로비전된 IOPS </td>
    <td> 있음 </td>
    <td> 
        <b>EBS 최적화O + 프로비전된 IOPS O</b>
        <br/> 성능: 안정적, 피크 성능: 높음
    </td>
    <td> 
        <b>EBS 최적화X + 프로비전된 IOPS O</b> 
        <br/>사용 하지 말것 
    </td>
</tr>
<tr>
    <td> 없음 </td>
    <td> 
        <b>EBS 최적화O + 프로비전된 IOPS O</b>
        <br/> 성능: 안정적, 피크 성능: 낮음
    </td>
    <td> 
        <b>EBS 최적화O + 프로비전된 IOPS O</b>
        <br/> 성능: 불안정, 피크 성능: 낮음
    </td>
</tr>
</table>

<br/>

대개 이용률(실행 시간의 비율)이 60~70%를 초과하면 예약 인스턴스를 이용하는 것이 저렴한데, 기업 사이트는 항상 운영되어야 하기 때문에 이용률은 100%에 가까움
-> EC2 인스턴스에는 예약 인스턴스를 사용하는 것이 적합 

<br/>

**예약 인스턴스 단점**
- 취소 불가. 이용률이 낮아지면 온디멘드와 비교하여 오히려 더 비싸지게 됨
- 서비스 이전(Churn)에 대한 자유도가 떨어짐
  -  일정 기간 동안 높은 가동률이 예상되는 EC2 인스턴스에 대해서 예약 인스턴스를 이용하는 것이 낫다. (e.g. 필자의 소속 회사는 1년과 3년간의 할인율 차이가 작기 때문에 1년 단위의 예약 인스턴스를 이용)

<br/>


### 스케일링

스케일링? 시스템으로의 접속 수가 증가하면 처리 능력을 키울 방법이 필요한데, 이렇게 시스템의 처리 능력을 키우는 것을 의미

 AWS는 스케일링하는 구체적인 방법으로 스케일 업(scale-up)과 스케일 아웃(scale-out)을 제공합니다. 

 <br/>
 
 **스케일 업의 두 가지 커다란 제약**
 - 단일 노드의 스펙 상한이 시스템의 처리 성능 한계가 되어버린다는 점
 - 인스턴스 용량을 변경할 때 일시적으로 중단이 필요하다는 점

**스케일 아웃의 장점**
- 이에 비해 스케일 아웃은 노드 수를 늘리는 것으로 스케일링을 하기 때문에 상한선 제약 없이 동적으로 적용 가능
- AWS에서는 동적으로 스케일 아웃을 하는 기능을 제공
- 처리 능력을 확장시키는 작업을 자동화할 수 있음

하지만 여러 노드에서 병렬로 작업을 수행하려면 처리 결과나 데이터에 불일치가 일어나지 않도록 고려해야 하기 때문에 선택의 제약을 받을 수 있음

<small>스케일 업, 스케일 아웃과는 반대로 인스턴스 용량을 낮추거나 처리 노드 수를 줄이는 것을 각각 스케일 다운, 스케일 인이라고 한다.</small>

<br/><br/><br/>
