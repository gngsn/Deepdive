# NAT

NAT: Network Address Translation,네트워크 주소 변환

## NAT Instance

: 네트워크 패킷 재작성

- 사설 서브넷 EC2 인스턴스가 인터넷에 연결되도록 허용
- NAT 인스턴스는 공용 서브넷에서 실행되어야 하고, 공용 및 사설 서브넷을 연결
- 소스/목적지 확인 설정을 비활성화해야 함 => 소스/목적지 IP가 NAT Instance에 의해 변경되기 때문
- NAT 인스턴스에는 고정된 탄력적 IP가 연결되어야 함


### NAT Instance Overview

<img src="../../img/natInstance.png" style="max-width: 60%" />

**사설 서브넷에 위치한 인스턴스가 IP는 외부 서버로 액세스하기 위해 NAT 인스턴스를 통과해야 함**
접속하려는 서버 IP: 50.60.4.10

1. 사설 서브넷에서 외부 인터넷 액세스 시도 Dest: 50.60.4.10
2. 공용 서브넷에 보안 그룹이 있는 NAT 인스턴스를 실행
3. NAT 인스턴스에 탄력적 IP를 연결
4. 사설 서브넷의 라우팅 테이블을 수정: 사설 서브넷의 모든 대역이 NAT 인스턴스로 트래픽으로 전송되게 설정
   - `0.0.0.0/0` -> NAT instance
5. 사설 서브넷의 인스턴스가 외부 서버로 요청을 보내기 위해 NAT 인스턴스로 요청 전달: 
   - **소스 IP: `10.0.0.20` (Private IP)**
   - 목적지 IP: `50.60.4.10` (외부 서버 IP)
6. NAT 인스턴스가 외부 서버로 요청을 전달
   - **소스 IP: `12.34.56.78` (NAT 인스턴스 Public IP)**
   - 목적지 IP: `50.60.4.10` (외부 서버 IP)
   - ⭐️ 네트워크 패킷이 NAT 인스턴스로 재작성됨 (NAT 인스턴스의 역할)
7. 서버에서 응답
   - 소스 IP: `50.60.4.10` (외부 서버 IP)
   - 목적지 IP: `12.34.56.78` (NAT 인스턴스 Public IP)
8. NAT 인스턴스가 다시 EC2 인스턴스로 트래픽을 회신
   - 소스 IP: `50.60.4.10` (외부 서버 IP)
   - 목적지 IP: `10.0.0.20` (NAT 인스턴스 Public IP)


### NAT 인스턴스 단점
- 가용성이 높지 않음
- 초기화 설정으로 복원할 수 없어 여러 AZ에 ASG를 생성해야 함
- 복원되는 사용자 데이터 스크립트가 필요하기에 복잡함
- 작은 인스턴스는 큰 인스턴스에 비교해서 대역폭이 더 작음
- 보안 그룹과 규칙을 관리해야 함
- 인바운드에서는, 사설 서브넷의 HTTP/HTTPS 트래픽을 허용하고, SSH도 허용해야 함


